# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è E2E —Ç–µ—Å—Ç–æ–≤

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

E2E —Ç–µ—Å—Ç—ã **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è:

1. **–°–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤
2. **–û—á–∏—â–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å—Ç—É—Ä—É `clean_test_database`)
3. **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ë–î** - –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ production –¥–∞–Ω–Ω—ã–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–¢–µ—Å—Ç–æ–≤–∞—è –ë–î –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `TEST_DATABASE_URL`:

```env
# –í .env.test –∏–ª–∏ .env
TEST_DATABASE_URL=sqlite:///test_database_e2e.db
```

–ï—Å–ª–∏ `TEST_DATABASE_URL` –Ω–µ —É–∫–∞–∑–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: `sqlite:///test_database_e2e.db`

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ë–î

1. **–§–∏–∫—Å—Ç—É—Ä–∞ `setup_test_database`** (scope="session"):
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
   - –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `bot.config.DATABASE_URL` –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
   - –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `bot.database.db.engine` –∏ `bot.database.db.SessionLocal`
   - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –ë–î (—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã)

2. **–§–∏–∫—Å—Ç—É—Ä–∞ `clean_test_database`** (autouse=True):
   - –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –û—á–∏—â–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≥–æ—Ä–æ–¥–∞, –≤–∞–ª—é—Ç—ã) - –æ–Ω–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è

### –ü–æ—Ä—è–¥–æ–∫ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö

–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª—è—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–∏–∑-–∑–∞ foreign keys):

1. `Booking` - –∑–∞–ø–∏—Å–∏/–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
2. `UserMaster` - —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å-–º–∞—Å—Ç–µ—Ä
3. `Portfolio` - —Ñ–æ—Ç–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
4. `WorkPeriod` - —Ä–∞–±–æ—á–∏–µ –ø–µ—Ä–∏–æ–¥—ã
5. `Service` - —É—Å–ª—É–≥–∏
6. `ServiceCategory` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥
7. `Payment` - –ø–ª–∞—Ç–µ–∂–∏
8. `User` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
9. `MasterAccount` - –º–∞—Å—Ç–µ—Ä–∞

**–°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è:**
- `City` - –≥–æ—Ä–æ–¥–∞ (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)
- `CountryCurrency` - –≤–∞–ª—é—Ç—ã —Å—Ç—Ä–∞–Ω (—Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤** - –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —á–∏—Å—Ç–æ–π –ë–î
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –æ—Å–Ω–æ–≤–Ω–∞—è –ë–î –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è
3. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –æ—á–∏—â–∞—Ç—å –ë–î
4. **–°–∫–æ—Ä–æ—Å—Ç—å** - –±—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–¢–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç–µ—Å—Ç–æ–≤—É—é –ë–î. –ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ:

```python
@pytest.mark.asyncio
@pytest.mark.e2e_telethon
async def test_master_registration(telethon_client, test_master_bot):
    # –ë–î —É–∂–µ –æ—á–∏—â–µ–Ω–∞ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —Ç–µ—Å—Ç–æ–º
    # –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –Ω–∞—á–∏–Ω–∞—Ç—å —Ç–µ—Å—Ç
    # ...
```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤ —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –¢–µ—Å—Ç–æ–≤—ã–µ –±–æ—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—É –∂–µ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î, —á—Ç–æ –∏ —Ç–µ—Å—Ç—ã!

#### –°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
python run_test_bots.py
```

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ `.env.test`
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `DATABASE_URL` –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ–±–∞ –±–æ—Ç–∞ (master –∏ client)

#### –°–ø–æ—Å–æ–± 2: –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# Windows
set DATABASE_URL=sqlite:///test_database_e2e.db
python run_master.py

# Linux/Mac
export DATABASE_URL=sqlite:///test_database_e2e.db
python run_master.py
```

–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ `.env` –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤:

```env
DATABASE_URL=sqlite:///test_database_e2e.db
TEST_MASTER_BOT_TOKEN=your_test_master_bot_token
TEST_CLIENT_BOT_TOKEN=your_test_client_bot_token
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env.test`:

```env
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –ë–î –¥–ª—è —Ç–µ—Å—Ç–æ–≤
TEST_DATABASE_URL=sqlite:///test_database_e2e.db

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î –≤ –ø–∞–º—è—Ç–∏ (–±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞)
TEST_DATABASE_URL=sqlite:///:memory:

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TEST_DATABASE_URL=sqlite:///tests/test_database_e2e.db
```

### –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î **–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è** –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).

–ß—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å –ë–î –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∫–æ–¥ –≤ `database_fixtures.py`:

```python
# –í —Ñ–∏–∫—Å—Ç—É—Ä–µ test_database_file
if os.path.exists(db_path):
    os.remove(db_path)
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–¢–µ—Å—Ç–æ–≤—ã–µ –±–æ—Ç—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î**
   - –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –±–æ—Ç–æ–≤ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `TEST_DATABASE_URL`
   - –ò–ª–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `DATABASE_URL=sqlite:///test_database_e2e.db`

2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤**
   - –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Ç–µ—Å—Ç—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
   - –ù–∞–ø—Ä–∏–º–µ—Ä: `TEST_DATABASE_URL=sqlite:///test_database_e2e_{pytest_xdist_worker_id}.db`

3. **–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö**
   - –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–∞—é—Ç—Å—è **–ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º**, –Ω–æ **–Ω–µ –ø–æ—Å–ª–µ**
   - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å —Ç–µ—Å—Ç—ã, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—è –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î:

```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite
sqlite3 test_database_e2e.db

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü
.tables

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Å—Ç–µ—Ä–æ–≤
SELECT * FROM master_accounts;

# –ü—Ä–æ—Å–º–æ—Ç—Ä —É—Å–ª—É–≥
SELECT * FROM services;
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤–∞—è –ë–î

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ç–µ—Å—Ç:

```python
import bot.config
print(f"Using database: {bot.config.DATABASE_URL}")
```

–î–æ–ª–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏: `sqlite:///test_database_e2e.db` (–∏–ª–∏ –≤–∞—à–µ –∑–Ω–∞—á–µ–Ω–∏–µ `TEST_DATABASE_URL`)

## üìù –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç

```python
@pytest.mark.asyncio
@pytest.mark.e2e_telethon
async def test_master_registration(telethon_client, test_master_bot):
    # –ë–î —É–∂–µ –æ—á–∏—â–µ–Ω–∞, –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ç–µ—Å—Ç
    messages = await send_message_and_wait(telethon_client, test_master_bot, "/start")
    # ...
```

### –ü—Ä–∏–º–µ—Ä 2: –¢–µ—Å—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ë–î

```python
@pytest.mark.asyncio
@pytest.mark.e2e_telethon
async def test_master_created(telethon_client, test_master_bot):
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞—Å—Ç–µ—Ä–∞
    # ...
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î
    from bot.database.db import get_session, get_master_by_telegram
    me = await telethon_client.get_me()
    
    with get_session() as session:
        master = get_master_by_telegram(session, me.id)
        assert master is not None  # –ú–∞—Å—Ç–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω
```

## üéØ –ò—Ç–æ–≥–æ

- ‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ë–î –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ –ë–î –æ—á–∏—â–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º
- ‚úÖ –û—Å–Ω–æ–≤–Ω–∞—è –ë–î –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å —Ç–µ—Å—Ç—ã, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—è –¥–∞–Ω–Ω—ã–µ –≤ –ë–î

