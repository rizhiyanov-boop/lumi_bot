# üîÑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Workflow –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∞–≥–∞–º–∏

## –ü—Ä–æ–±–ª–µ–º–∞

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ ConversationHandler, —á—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç:
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —à–∞–≥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —à–∞–≥–æ–≤
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

## –†–µ—à–µ–Ω–∏–µ: –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π Workflow

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **`bot/core/workflow.py`** - –±–∞–∑–æ–≤—ã–π –º–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è workflow
2. **`bot/workflows/`** - –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö workflow

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Workflow

```python
Workflow(
    name="add_service",           # –ò–º—è workflow
    entry_point="category",       # ID –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞
    steps={                        # –°–ª–æ–≤–∞—Ä—å —à–∞–≥–æ–≤
        "category": Step(...),
        "name": Step(...),
        "price": Step(...)
    },
    fallbacks=["cancel"],         # ID —à–∞–≥–æ–≤ –¥–ª—è –æ—Ç–º–µ–Ω—ã
    context_keys=[...]            # –ö–ª—é—á–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
)
```

### –¢–∏–ø—ã —à–∞–≥–æ–≤

1. **MESSAGE** - –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **INPUT** - –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
3. **CALLBACK** - –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º
4. **CONDITIONAL** - —É—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
5. **ACTION** - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ

### –ü—Ä–∏–º–µ—Ä: Workflow –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏

```python
workflow = Workflow(
    name="add_service",
    entry_point="category",
    steps={
        "category": Step(
            id="category",
            type=StepType.CALLBACK,
            message="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
            handler=build_category_keyboard,
            next_step="name",
            data_key="category_id"
        ),
        "name": Step(
            id="name",
            type=StepType.INPUT,
            message="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
            validator=lambda text, ctx: True if text else "–û—à–∏–±–∫–∞",
            data_key="name",
            next_step="price"
        ),
        "price": Step(
            id="price",
            type=StepType.INPUT,
            message="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É:",
            validator=validate_price,
            data_key="price",
            next_step="duration"
        )
    }
)
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–õ–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫** - –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π—Ç–µ `next_step`
2. **–õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —à–∞–≥** - –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π Step –≤ —Å–ª–æ–≤–∞—Ä—å
3. **–õ–µ–≥–∫–æ —É–¥–∞–ª–∏—Ç—å —à–∞–≥** - —É–¥–∞–ª–∏—Ç–µ –∏–∑ —Å–ª–æ–≤–∞—Ä—è –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å–≤—è–∑–∏
4. **–£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `condition` –∏–ª–∏ `skip_if`
5. **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –æ–¥–∏–Ω workflow –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from bot.core.workflow import workflow_manager
from bot.workflows.add_service_workflow import create_add_service_workflow

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
workflow = create_add_service_workflow()
workflow_manager.register_workflow(workflow)

# –ó–∞–ø—É—Å–∫
await workflow_manager.start_workflow(update, context, "add_service")
```

## –ú–∏–≥—Ä–∞—Ü–∏—è

1. –°–æ–∑–¥–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ workflow –≤ `bot/workflows/`
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `main_master.py`
3. –ó–∞–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—ã–∑–æ–≤—ã workflow_manager
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–°–º. `docs/architecture/WORKFLOW_EXAMPLE.md` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. –ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
- **–ë—ã–ª–æ:** –ù—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–¥ –≤ 3-5 –º–µ—Å—Ç–∞—Ö
- **–°—Ç–∞–ª–æ:** –ú–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ `next_step` –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

### 2. –õ–µ–≥–∫–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —à–∞–≥–æ–≤
- **–ë—ã–ª–æ:** –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –æ–±–Ω–æ–≤–∏—Ç—å ConversationHandler
- **–°—Ç–∞–ª–æ:** –î–æ–±–∞–≤–∏—Ç—å Step –≤ —Å–ª–æ–≤–∞—Ä—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∏

### 3. –£—Å–ª–æ–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
- **–ë—ã–ª–æ:** –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- **–°—Ç–∞–ª–æ:** –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `condition` –∏–ª–∏ `skip_if`

### 4. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- **–ë—ã–ª–æ:** –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è –ø–æ—Ö–æ–∂–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- **–°—Ç–∞–ª–æ:** –û–¥–∏–Ω workflow –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö

### 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
- **–ë—ã–ª–æ:** –°–ª–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–≥–∏
- **–°—Ç–∞–ª–æ:** –ö–∞–∂–¥—ã–π —à–∞–≥ - –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –µ–¥–∏–Ω–∏—Ü–∞

### 6. –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å
- **–ë—ã–ª–æ:** –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–∞ –ø–æ —Ñ–∞–π–ª–∞–º
- **–°—Ç–∞–ª–æ:** –í—Å–µ —à–∞–≥–∏ –æ–ø–∏—Å–∞–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –≤–∏–¥–Ω–∞ –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (`bot/core/workflow.py`)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã workflow (`bot/workflows/`)
3. ‚è≥ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏ –Ω–∞ –Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥
4. ‚è≥ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
5. ‚è≥ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
6. ‚è≥ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–ª–∏–µ–Ω—Ç-–±–æ—Ç)

