# üè¢ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º—É–ª—å—Ç–∏–∫–ª—É–±–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** —á–µ—Ä–µ–∑ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
2. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –∫–∞–∂–¥–æ–≥–æ –∫–ª—É–±–∞
3. **–ù–µ–∑–∞–≤–∏—Å–∏–º–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—É–±–∞
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π** –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ä–∞–∑–Ω—ã—Ö –∫–ª—É–±–æ–≤

---

## üéØ –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: Deep Links —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–ª—É–±–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram Deep Links —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∫–ª—É–±–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
https://t.me/YourBot?start=club_kaluga
https://t.me/YourBot?start=club_moscow
https://t.me/YourBot?start=club_spb
```

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ –±–æ—Ç –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª—É–±–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î

**–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `clubs`:**
```python
class Club(Base):
    """–ö–ª—É–± - –≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏"""
    __tablename__ = 'clubs'
    
    id = Column(Integer, primary_key=True)
    slug = Column(String(50), unique=True, nullable=False)  # kaluga, moscow, spb
    name = Column(String(100), nullable=False)  # "–ü–µ–π–Ω—Ç–±–æ–ª –ö–∞–ª—É–≥–∞"
    active = Column(Boolean, default=True)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª—É–±–∞
    work_start = Column(String(5), default="09:00")
    work_end = Column(String(5), default="21:00")
    timezone = Column(String(50), default="Europe/Moscow")
    
    # –°–≤—è–∑–∏
    locations = relationship("Location", back_populates="club")
    user_contexts = relationship("UserContext", back_populates="club")
    admins = relationship("ClubAdmin", back_populates="club")
```

**–ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ `user_contexts`:**
```python
class UserContext(Base):
    """–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∫ –∫–∞–∫–æ–º—É –∫–ª—É–±—É –ø—Ä–∏–≤—è–∑–∞–Ω"""
    __tablename__ = 'user_contexts'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, unique=True, nullable=False)  # Telegram user ID
    club_id = Column(Integer, ForeignKey('clubs.id'), nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # –°–≤—è–∑–∏
    club = relationship("Club", back_populates="user_contexts")
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `locations`:**
```python
class Location(Base):
    """–õ–æ–∫–∞—Ü–∏—è –ø–µ–π–Ω—Ç–±–æ–ª—å–Ω–æ–≥–æ –∫–ª—É–±–∞"""
    __tablename__ = 'locations'
    
    id = Column(Integer, primary_key=True)
    club_id = Column(Integer, ForeignKey('clubs.id'), nullable=False)  # ‚Üê –ù–û–í–û–ï
    name = Column(String(100), nullable=False)
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    
    # Relationships
    club = relationship("Club", back_populates="locations")  # ‚Üê –ù–û–í–û–ï
    fields = relationship("Field", back_populates="location")
```

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `admins`:**
```python
class ClubAdmin(Base):
    """–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –∫–ª—É–±–∞"""
    __tablename__ = 'club_admins'
    
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, nullable=False)  # –ù–ï unique - –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º –≤ —Ä–∞–∑–Ω—ã—Ö –∫–ª—É–±–∞—Ö
    club_id = Column(Integer, ForeignKey('clubs.id'), nullable=False)  # ‚Üê –ù–û–í–û–ï
    
    username = Column(String(100))
    notify = Column(Boolean, default=True)
    is_super_admin = Column(Boolean, default=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    
    # –°–≤—è–∑–∏
    club = relationship("Club", back_populates="admins")
    
    # –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å: –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –æ–¥–Ω–æ–º –∫–ª—É–±–µ
    __table_args__ = (
        UniqueConstraint('user_id', 'club_id', name='unique_admin_per_club'),
    )
```

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

**1. –û–±—Ä–∞–±–æ—Ç–∫–∞ Deep Link –≤ `/start`:**

```python
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä deep link
    args = context.args
    club_slug = None
    
    if args and args[0].startswith('club_'):
        club_slug = args[0].replace('club_', '')
    
    with get_session() as session:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_context = session.query(UserContext).filter_by(
            user_id=user.id
        ).first()
        
        if not user_context and club_slug:
            # –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–ª—É–±–∞
            club = session.query(Club).filter_by(slug=club_slug, active=True).first()
            
            if club:
                # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                user_context = UserContext(
                    user_id=user.id,
                    club_id=club.id
                )
                session.add(user_context)
                session.commit()
                
                await update.message.reply_text(
                    f"üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {club.name}!",
                    reply_markup=get_main_menu_keyboard(is_admin)
                )
            else:
                await update.message.reply_text(
                    "‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∫–ª—É–±–∞."
                )
                return
        
        elif not user_context:
            # –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ - –∑–∞–ø—Ä–µ—â–∞–µ–º –¥–æ—Å—Ç—É–ø
            await update.message.reply_text(
                "‚ö†Ô∏è –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç –≤–∞—à–µ–≥–æ –∫–ª—É–±–∞."
            )
            return
        
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–ª—É–±—É
        club = user_context.club
        is_admin = is_club_admin(session, user.id, club.id)
        
        await update.message.reply_text(
            f"üëã –ü—Ä–∏–≤–µ—Ç! –í—ã –≤ —Å–∏—Å—Ç–µ–º–µ {club.name}",
            reply_markup=get_main_menu_keyboard(is_admin)
        )
```

**2. Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**

```python
def require_club_context(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª—É–±–∞"""
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user = update.effective_user
        
        with get_session() as session:
            user_context = get_user_context(session, user.id)
            
            if not user_context:
                await update.message.reply_text(
                    "‚ö†Ô∏è –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–ª—É–±—É. "
                    "–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞."
                )
                return
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º club_id –≤ context –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handler
            context.user_data['club_id'] = user_context.club_id
            
            return await func(update, context)
    
    return wrapper
```

**3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª—É–±—É:**

```python
def get_all_locations(session: Session, club_id: int, active_only: bool = True):
    """–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ª–æ–∫–∞—Ü–∏–∏ –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –∫–ª—É–±–∞"""
    query = session.query(Location).filter(Location.club_id == club_id)
    if active_only:
        query = query.filter(Location.active == True)
    return query.all()

def get_user_bookings(session: Session, user_id: int, club_id: int):
    """–ü–æ–ª—É—á–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –í –†–ê–ú–ö–ê–• –∫–ª—É–±–∞"""
    return session.query(Booking).join(Field).join(Location).filter(
        Booking.user_id == user_id,
        Location.club_id == club_id
    ).all()
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ‚úÖ

1. **–ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
2. **–£–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –æ–¥–Ω–∞ —Å—Å—ã–ª–∫–∞ = –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–ª—É–±—É
3. **–ì–∏–±–∫–æ—Å—Ç—å** - –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É –∫–ª—É–±–∞–º–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
4. **–û–¥–∏–Ω –±–æ—Ç** - —ç–∫–æ–Ω–æ–º–∏—è –Ω–∞ —Ç–æ–∫–µ–Ω–∞—Ö –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
5. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - –æ–¥–Ω–∞ –ë–î, –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ ‚ö†Ô∏è

1. **–û–±—â–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - –Ω—É–∂–Ω–∞ —Ç—â–∞—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
2. **–û–±—â–∏–π rate limit Telegram** - –≤—Å–µ –∫–ª—É–±—ã –¥–µ–ª—è—Ç –ª–∏–º–∏—Ç—ã
3. **–ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –æ—Ç–∫–∞–∑–∞** - –µ—Å–ª–∏ –±–æ—Ç —É–ø–∞–ª, –≤—Å–µ –∫–ª—É–±—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
4. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è** - –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Ç–¥–µ–ª—å–Ω—ã–µ –±–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—É–±–∞

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–ö–∞–∂–¥—ã–π –∫–ª—É–± –ø–æ–ª—É—á–∞–µ—Ç —Å–≤–æ–π –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ—Ç —Å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–ö–ª—É–± –ö–∞–ª—É–≥–∞:
- –ë–æ—Ç: @PaintballKalugaBot
- Token: 123456:ABC...
- –ë–î: paintball_kaluga.db

–ö–ª—É–± –ú–æ—Å–∫–≤–∞:
- –ë–æ—Ç: @PaintballMoscowBot
- Token: 789012:DEF...
- –ë–î: paintball_moscow.db
```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
paintball-system/
‚îú‚îÄ‚îÄ shared/                    # –û–±—â–∏–π –∫–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ
‚îú‚îÄ‚îÄ clubs/
‚îÇ   ‚îú‚îÄ‚îÄ kaluga/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env              # BOT_TOKEN –¥–ª—è –ö–∞–ª—É–≥–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.db
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ moscow/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env              # BOT_TOKEN –¥–ª—è –ú–æ—Å–∫–≤—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.db
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ run.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ spb/
‚îÇ       ‚îú‚îÄ‚îÄ .env
‚îÇ       ‚îú‚îÄ‚îÄ database.db
‚îÇ       ‚îî‚îÄ‚îÄ run.py
```

#### –ó–∞–ø—É—Å–∫

```python
# clubs/kaluga/run.py
import sys
sys.path.append('../..')

from shared.bot import create_bot
from shared.config import load_config

config = load_config('.env')
bot = create_bot(config)
bot.run()
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ‚úÖ

1. **–ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è** - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ë–î, —Ç–æ–∫–µ–Ω—ã, –ø—Ä–æ—Ü–µ—Å—Å—ã
2. **–ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–∞–∂–¥—ã–π –±–æ—Ç –Ω–∞ —Å–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ
3. **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** - –ø–∞–¥–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –±–æ—Ç–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥—Ä—É–≥–∏–µ
4. **–ü—Ä–æ—Å—Ç–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
5. **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ rate limits** - –∫–∞–∂–¥—ã–π –±–æ—Ç –∏–º–µ–µ—Ç —Å–≤–æ–∏ –ª–∏–º–∏—Ç—ã

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ ‚ö†Ô∏è

1. **–°–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** - –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å N –±–æ—Ç–æ–≤
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞** - —Ö–æ—Ç—è –º–æ–∂–Ω–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ shared
3. **–°—Ç–æ–∏–º–æ—Å—Ç—å** - –Ω—É–∂–Ω–æ N —Å–µ—Ä–≤–µ—Ä–æ–≤/–ø—Ä–æ—Ü–µ—Å—Å–æ–≤
4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—ã–π –±–æ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —Å namespace

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –æ–¥–∏–Ω –±–æ—Ç, –Ω–æ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ namespace –≤ callback_data.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–í—Å–µ callback_data –≤–∫–ª—é—á–∞—é—Ç club_id:

```python
# –í–º–µ—Å—Ç–æ:
callback_data = f"location_{location_id}"

# –ò—Å–ø–æ–ª—å–∑—É–µ–º:
callback_data = f"club_{club_id}:location_{location_id}"
```

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–ü–∞—Ä—Å–∏–Ω–≥ callback_data:**

```python
def parse_callback(callback_data: str):
    """–ü–∞—Ä—Å–∏–Ω–≥ callback —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º club_id"""
    parts = callback_data.split(':')
    
    if len(parts) == 2 and parts[0].startswith('club_'):
        club_id = int(parts[0].replace('club_', ''))
        action = parts[1]
        return club_id, action
    
    # Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    return None, callback_data

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
async def select_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    club_id, action = parse_callback(query.data)
    
    if not club_id:
        await query.answer("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞", show_alert=True)
        return
    
    location_id = int(action.split('_')[1])
    # ... rest of the logic with club_id filtering
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ ‚úÖ

1. **–Ø–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å** - club_id –≤—Å–µ–≥–¥–∞ –≤ callback
2. **–°–ª–æ–∂–Ω–µ–µ –æ—à–∏–±–∏—Ç—å—Å—è** - –Ω–µ—Ç –ø–æ–ª–∞–≥–∞–Ω–∏—è –Ω–∞ context
3. **–õ–µ–≥–∫–æ –æ—Ç–ª–∞–¥–∏—Ç—å** - –≤–∏–¥–Ω–æ –∫ –∫–∞–∫–æ–º—É –∫–ª—É–±—É –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏–µ

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ ‚ö†Ô∏è

1. **–î–ª–∏–Ω–Ω—ã–µ callback_data** - –µ—Å—Ç—å –ª–∏–º–∏—Ç –≤ 64 –±–∞–π—Ç–∞
2. **–ë–æ–ª—å—à–µ –∫–æ–¥–∞** - –Ω—É–∂–Ω–æ –≤–µ–∑–¥–µ –¥–æ–±–∞–≤–ª—è—Ç—å club_id
3. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏** - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ callback

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: Session-based –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å

#### –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–ª—É–±–∞ –≤ –ø–∞–º—è—Ç–∏.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```python
# –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π
user_sessions = {}  # {user_id: {'club_id': 1, 'last_action': datetime}}

class SessionManager:
    @staticmethod
    def set_club(user_id: int, club_id: int):
        user_sessions[user_id] = {
            'club_id': club_id,
            'last_action': datetime.now()
        }
    
    @staticmethod
    def get_club(user_id: int) -> Optional[int]:
        session = user_sessions.get(user_id)
        if not session:
            return None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Å—Å–∏—è –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ (24 —á–∞—Å–∞)
        if datetime.now() - session['last_action'] > timedelta(hours=24):
            del user_sessions[user_id]
            return None
        
        return session['club_id']
```

#### –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ ‚ö†Ô∏è

1. **–ü–æ—Ç–µ—Ä—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ** - –Ω—É–∂–Ω–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
2. **–ü–∞–º—è—Ç—å** - –º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π = –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏
3. **–ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** –¥–ª—è production

---

## üèÜ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –í–∞—Ä–∏–∞–Ω—Ç 1 (Deep Links)

### –ü–æ—á–µ–º—É –í–∞—Ä–∏–∞–Ω—Ç 1?

1. ‚úÖ **–ë–∞–ª–∞–Ω—Å –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**
2. ‚úÖ **–õ–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –¥–æ –í–∞—Ä–∏–∞–Ω—Ç–∞ 2 –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏**
3. ‚úÖ **–ú–µ–Ω—å—à–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –∫–æ–¥–µ**
4. ‚úÖ **–£–¥–æ–±–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –æ–¥–Ω–∞ —Å—Å—ã–ª–∫–∞
5. ‚úÖ **–≠–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤** - –æ–¥–∏–Ω –±–æ—Ç

### –ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ –í–∞—Ä–∏–∞–Ω—Ç 2?

- –ë–æ–ª–µ–µ **100 –∫–ª—É–±–æ–≤**
- **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å** (—Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã/—á–∞—Å–æ–≤—ã–µ –ø–æ—è—Å–∞)
- **–†–∞–∑–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
- **–†–µ–≥—É–ª—è—Ç–æ—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è** (—Ä–∞–∑–Ω—ã–µ —é—Ä–∏—Å–¥–∏–∫—Ü–∏–∏)

---

## üìù –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –í–∞—Ä–∏–∞–Ω—Ç 1

### –≠—Ç–∞–ø 1: –ò–∑–º–µ–Ω–µ–Ω–∏—è –ë–î

1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `clubs`
2. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `user_contexts`
3. –î–æ–±–∞–≤–∏—Ç—å `club_id` –≤ `locations`
4. –ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `admins` –≤ `club_admins` —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∫–ª—É–±—É

### –≠—Ç–∞–ø 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π –ë–î

1. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∫–∏: `get_all_locations()`, `get_user_bookings()` –∏ —Ç.–¥.
2. –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ `club_id`
3. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `user_contexts`

### –≠—Ç–∞–ø 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. –û–±–Ω–æ–≤–∏—Ç—å `/start` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ deep links
2. –î–æ–±–∞–≤–∏—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
3. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ handlers –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `club_id` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –≠—Ç–∞–ø 4: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

1. –°–æ–∑–¥–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∫–ª—É–± –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
2. –ü—Ä–∏–≤—è–∑–∞—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–æ–∫–∞—Ü–∏–∏ –∫ —ç—Ç–æ–º—É –∫–ª—É–±—É
3. –ü—Ä–∏–≤—è–∑–∞—Ç—å –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–¥–º–∏–Ω–æ–≤

### –≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å 2-3 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∫–ª—É–±–∞
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ club_id –≤–æ –í–°–ï–• –∑–∞–ø—Ä–æ—Å–∞—Ö**
   ```python
   # ‚ùå –ü–ª–æ—Ö–æ
   booking = session.query(Booking).filter_by(id=booking_id).first()
   
   # ‚úÖ –•–æ—Ä–æ—à–æ
   booking = session.query(Booking).join(Field).join(Location).filter(
       Booking.id == booking_id,
       Location.club_id == user_club_id
   ).first()
   ```

2. **–ó–∞–ø—Ä–µ—Ç —Å–º–µ–Ω—ã –∫–ª—É–±–∞ –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è**
   ```python
   if existing_context and new_club_id != existing_context.club_id:
       # –¢—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞
       await send_admin_notification(...)
   ```

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –º–µ–∂–∫–ª—É–±–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**
   ```python
   if user_is_multi_club_admin:
       log_action(user_id, f"Access to club {club_id}")
   ```

---

## üìä –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è 3 –∫–ª—É–±–æ–≤

```
–ö–ª—É–± "–ö–∞–ª—É–≥–∞"
‚îú‚îÄ‚îÄ slug: kaluga
‚îú‚îÄ‚îÄ –°—Å—ã–ª–∫–∞: t.me/PaintballBot?start=club_kaluga
‚îú‚îÄ‚îÄ –õ–æ–∫–∞—Ü–∏–∏: –ö–∞–ª—É–≥–∞ 2, –ë—É–Ω–∫–µ—Ä
‚îú‚îÄ‚îÄ –ê–¥–º–∏–Ω—ã: User123, User456
‚îî‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: 150 —á–µ–ª–æ–≤–µ–∫

–ö–ª—É–± "–ú–æ—Å–∫–≤–∞"
‚îú‚îÄ‚îÄ slug: moscow
‚îú‚îÄ‚îÄ –°—Å—ã–ª–∫–∞: t.me/PaintballBot?start=club_moscow
‚îú‚îÄ‚îÄ –õ–æ–∫–∞—Ü–∏–∏: –¶–ü–ö–∏–û, –°–æ–∫–æ–ª—å–Ω–∏–∫–∏
‚îú‚îÄ‚îÄ –ê–¥–º–∏–Ω—ã: User789
‚îî‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: 320 —á–µ–ª–æ–≤–µ–∫

–ö–ª—É–± "–°–ü–ë"
‚îú‚îÄ‚îÄ slug: spb
‚îú‚îÄ‚îÄ –°—Å—ã–ª–∫–∞: t.me/PaintballBot?start=club_spb
‚îú‚îÄ‚îÄ –õ–æ–∫–∞—Ü–∏–∏: –ü–µ—Ç–µ—Ä–≥–æ—Ñ, –ö—Ä–æ–Ω—à—Ç–∞–¥—Ç
‚îú‚îÄ‚îÄ –ê–¥–º–∏–Ω—ã: User321, User654
‚îî‚îÄ‚îÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: 210 —á–µ–ª–æ–≤–µ–∫
```

---

## üöÄ –ì–æ—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–•–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —è –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª:
1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ë–î
2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
3. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ handlers —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
4. ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª—É–±–æ–≤
5. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

–≠—Ç–æ –∑–∞–π–º–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 2-4 —á–∞—Å–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –±–∞–∑–æ–≤–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –í–∞—Ä–∏–∞–Ω—Ç–∞ 1.



